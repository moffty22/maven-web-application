pipeline{
   agent any
   //options{}
   //triggers{}
   tools {
      maven 'maven3.9.9'
   }
   environment {
       IMAGE_NAME = 'edsam22/maven-web-app'
       IMAGE_TAG = "${IMAGE_NAME}:${env.GIT_COMMIT}"
       //DOCKERHUB_CREDENTIALS_ID = credentials('docker_cred')
       ARGOCD_TOKEN = credentials('argocd-token')
       GITHUB_TOKEN = credentials('github')
       VERSION = "${env.BUILD_ID}-${env.GIT_COMMIT}"

   }

   stages{
    stage('1.CloneCode'){
      steps{
         sh  "echo cloning the latest app version"
         git 'https://github.com/moffty22/maven-web-application.git'
      }
    }
      stage('Test+Build'){
      steps{
        sh "echo Running unitTesting"
        sh "mvn clean package"
        echo "echo test successful and backupArtifacts created"
      }
    }
    }

      stage('codeQuality'){
      steps{
        sh "echo Running detail code analysis"
        //sh "mvn sonar:sonar"
        sh  "echo All conditions met/passed"
      }
    }
      stage('upLoadArtifacts'){
      steps{
        sh "echo Running detail code analysis"
        //sh "mvn deploy"
        sh "echo backupArtifacts in nexus"
      }
    }

    stage('login to dockerhub'){
      steps{
           withCredentials([usernamePassword(credentialsId: 'docker_cred', passwordVariable: 'password', usernameVariable: 'username')]) {
           sh "echo $password | docker login -u $username --password-stdin"}
           
      }
    }
      stage('Build docker image'){
      steps{
        sh "echo creating docker image"
        sh "docker build -t ${IMAGE_TAG} ."
        sh 'docker image ls'
      }
    }

    stage('Push docker image'){
      steps{
          sh "docker push ${IMAGE_TAG}"
          echo "Docker image push successfully"
      }
    }

    stage('Update Manifest') {
      steps {
        dir('maven-web-app-deploy-k8') {
            sh '''
                sed -i "s#edsam22/maven-web-app.*#${IMAGE_NAME}:${VERSION}#g" deployment.yaml
                cat deployment.yaml
            '''
        }
    }
}
    stage('Commit & Push') {
      steps {
        dir('maven-web-app-deploy-k8') {
            sh '''
               git config --global user.email 'amponsah.edward@gmail.com' 
               git remote set-url origin https://$GITHUB_TOKEN@github.com/moffty22/maven-web-app-deploy-k8.git
               git checkout main
               git add -A
               git commit -m "Updated image version for Build - $VERSION"
               git push origin main
                
            '''
        }
    }
}
}
